import { FunctionComponent, useCallback, useState, useEffect } from 'react';
import styles from './Salon.module.css';
import Sidebar from '../SideBar/Sidebar';
import PageHeader from '../PageHeader/PageHeader';
import HeadphoneImage from '../../images/Salon/headphones.svg';
import SendImage from '../../images/Salon/send.svg';
import MatchDetails from '../../components/MatchDetails/MatchDetails';
import SendResult from '../../components/SendResult/SendResult';
import { challengeService } from '../../services/api';
import { toast } from 'react-toastify';
import { useParams, useNavigate } from 'react-router-dom';
import { Helmet } from 'react-helmet';
import PSlogo from '../../images/konsolLogolarÄ±/PSlogo.png';
import Xboxlogo from '../../images/konsolLogolarÄ±/XBOXlogo.png';

// Import game images
import fc24Image from '../../images/Games/fc24.jpeg';
import fc25Image from '../../images/Games/fc25.jpeg';
import nba2k24Image from '../../images/Games/nba2k24.png';
import nba2k25Image from '../../images/Games/nba2k25.jpeg';

const MalarmSalon = () => {
  const { matchId } = useParams();
  const navigate = useNavigate();
  const [matchStarted, setMatchStarted] = useState(false);
  const [showSendResult, setShowSendResult] = useState(false);
  const [message, setMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const [remainingTimeInSeconds, setRemainingTimeInSeconds] = useState(3600); // 1 saat = 3600 saniye
  const [matchData, setMatchData] = useState({
    id: null,
    gameName: "",
    remainingTime: "",
    createdAt: null,
    player1: {
      username: "",
      avatarUrl: null,
      ps5Id: "",
      consoleImage: PSlogo
    },
    player2: {
      username: "",
      avatarUrl: null,
      ps5Id: "",
      consoleImage: PSlogo
    },
    entryFee: 0,
    prize: 0
  });

  // Kalan sÃ¼re formatÄ±: 59:59
  const formatTime = (timeInSeconds) => {
    const minutes = Math.floor(timeInSeconds / 60);
    const seconds = timeInSeconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  };

  useEffect(() => {
    const fetchMatchDetails = async () => {
      try {
        setLoading(true);
        const response = await challengeService.getMatchDetails(matchId);
        
        if (response.success) {
          const matchData = response.data.match;
          
          // EÄŸer maÃ§ tamamlanmÄ±ÅŸsa, maÃ§lar sayfasÄ±na yÃ¶nlendir
          if (matchData.status === 'completed') {
            toast.info('Bu maÃ§ tamamlanmÄ±ÅŸ. TamamlanmÄ±ÅŸ maÃ§larÄ±n salonlarÄ±na eriÅŸilemez.');
            navigate('/matches');
            return;
          }
          
          // EÄŸer maÃ§ sonucu kullanÄ±cÄ± tarafÄ±ndan zaten raporlanmÄ±ÅŸsa salondan Ã§Ä±k
          if (matchData.results) {
            const { userRole, hostReported, opponentReported } = matchData.results;
            
            // KullanÄ±cÄ± kendi rolÃ¼ne gÃ¶re rapor gÃ¶nderdiyse eriÅŸimi engelle
            if ((userRole === 'host' && hostReported) || (userRole === 'opponent' && opponentReported)) {
              toast.info('Bu maÃ§ iÃ§in sonuÃ§ bildirdiniz. KarÅŸÄ± tarafÄ±n onayÄ± bekleniyor veya sonuÃ§ doÄŸrulanÄ±yor.');
              navigate('/matches');
              return;
            }
          }

          // MaÃ§Ä±n oluÅŸturulma zamanÄ±nÄ± al
          const createdAt = new Date(matchData.createdAt);
          const now = new Date();
          
          // OluÅŸturulma zamanÄ±ndan bu yana geÃ§en sÃ¼reyi hesapla (saniye cinsinden)
          const elapsedTimeInSeconds = Math.floor((now - createdAt) / 1000);
          
          // 1 saat = 3600 saniye, kalan sÃ¼reyi hesapla
          const remainingTime = Math.max(3600 - elapsedTimeInSeconds, 0);
          setRemainingTimeInSeconds(remainingTime);
          
          // KatÄ±lÄ±m Ã¼cretini al ve Ã¶dÃ¼lÃ¼ hesapla (1.8 katÄ±)
          const entryFee = matchData.entryFee || 0;
          const calculatedPrize = entryFee * 1.8;
          
          setMatchData({
            id: matchData.id,
            gameName: matchData.game || "",
            remainingTime: formatTime(remainingTime),
            createdAt: createdAt,
            player1: {
              username: matchData.host.username || "",
              avatarUrl: matchData.host.avatarUrl || null,
              ps5Id: matchData.host.ps5Id || "",
              consoleImage: PSlogo
            },
            player2: {
              username: matchData.opponent.username || "",
              avatarUrl: matchData.opponent.avatarUrl || null,
              ps5Id: matchData.opponent.ps5Id || "",
              consoleImage: PSlogo
            },
            entryFee: entryFee,
            prize: calculatedPrize // Hesaplanan Ã¶dÃ¼l deÄŸerini kullan
          });

          console.log('ğŸ’° Finansal Detaylar:', {
            'KatÄ±lÄ±m Ãœcreti': entryFee,
            'Ã–dÃ¼l': calculatedPrize,
            'Toplam Havuz': matchData.totalPrizePool
          });
        } else {
          toast.error('MaÃ§ bilgileri alÄ±namadÄ±');
          navigate('/matches');
        }
      } catch (error) {
        console.error('MaÃ§ detaylarÄ± yÃ¼klenirken hata:', error);
        toast.error('MaÃ§ bilgileri alÄ±namadÄ±');
        navigate('/matches');
      } finally {
        setLoading(false);
      }
    };

    fetchMatchDetails();
  }, [matchId, navigate]);

  // Kalan sÃ¼reyi azaltan sayaÃ§
  useEffect(() => {
    // EÄŸer yÃ¼kleme durumunda ise veya kalan sÃ¼re 0 ise, sayaÃ§ baÅŸlatma
    if (loading || remainingTimeInSeconds <= 0) return;

    const timer = setInterval(() => {
      setRemainingTimeInSeconds(prevTime => {
        const newTime = prevTime - 1;
        
        // Kalan sÃ¼reyi gÃ¼ncelle
        setMatchData(prevData => ({
          ...prevData,
          remainingTime: formatTime(newTime)
        }));
        
        // SÃ¼re bittiyse sayacÄ± durdur ve kullanÄ±cÄ±yÄ± bilgilendir
        if (newTime <= 0) {
          clearInterval(timer);
          toast.warning('MaÃ§ sÃ¼resi doldu! SonuÃ§ bildirmediyseniz maÃ§ otomatik olarak iptal edilecek.');
          setTimeout(() => {
            navigate('/matches');
          }, 3000);
          return 0;
        }
        
        return newTime;
      });
    }, 1000);

    // Component unmount olduÄŸunda sayacÄ± temizle
    return () => clearInterval(timer);
  }, [loading, remainingTimeInSeconds, navigate]);

  const onButonContainerClick = () => {
    setMatchStarted(true);
  };
  
  const onCancelRequestClick = () => {
    // Ä°ptal talebi gÃ¶nderme iÅŸlemi
  };

  const onReportResultClick = () => {
    setShowSendResult(true);
  };

  const handleMessageChange = (e) => {
    setMessage(e.target.value);
  };

  const handleSendMessage = () => {
    if (message.trim()) {
      console.log('GÃ¶nderilen mesaj:', message);
      setMessage('');
    }
  };

  // MaÃ§ sonucu bildirme fonksiyonu
  const handleDeclareResult = async (matchId, winnerId) => {
    try {
      setLoading(true);
      const response = await challengeService.declareMatchResult(matchId, winnerId);
      
      if (response.success) {
        const { match } = response.data;
        console.log('SonuÃ§ bildirildi:', {
          status: match.status,
          hostDeclaredWinner: match.hostDeclaredWinner,
          opponentDeclaredWinner: match.opponentDeclaredWinner
        });
        
        toast.success('MaÃ§ sonucu baÅŸarÄ±yla bildirildi');
        setShowSendResult(false); // SonuÃ§ gÃ¶nderme ekranÄ±nÄ± kapat
        
        // MaÃ§ durumuna gÃ¶re kullanÄ±cÄ±ya bilgi ver
        if (match.status === 'disputed') {
          toast.warning('Rakibiniz farklÄ± bir sonuÃ§ bildirdi. Ä°tiraz sÃ¼reci baÅŸlatÄ±ldÄ±.');
        } else if (match.status === 'completed') {
          toast.success('MaÃ§ sonucu onaylandÄ±!');
        }
        
        // SonuÃ§ bildirildikten sonra maÃ§larÄ±m sayfasÄ±na yÃ¶nlendir
        setTimeout(() => {
          navigate('/matches');
        }, 1500);
      }
    } catch (error) {
      console.error('SonuÃ§ bildirilirken hata:', error);
      toast.error(error.message || 'SonuÃ§ bildirilirken bir hata oluÅŸtu');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <div>YÃ¼kleniyor...</div>;
  }

  return (
    <div className={styles.malarmSalon}>
      <Helmet>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="" />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
      </Helmet>
      
      <Sidebar />
      
      <div className={styles.container}>
        <PageHeader headerTitle="MaÃ§ Salonu"/>
        <div className={styles.frameGroup}>
          {!showSendResult ? (
            <MatchDetails 
              matchData={matchData}
              matchStarted={matchStarted}
              onButonContainerClick={onButonContainerClick}
              onCancelRequestClick={onCancelRequestClick}
              onReportResultClick={onReportResultClick}
            />
          ) : (
            <SendResult 
              matchData={matchData}
              onBack={() => setShowSendResult(false)}
              onSubmitResult={(winnerId) => handleDeclareResult(matchData.id, winnerId)}
              loading={loading}
            />
          )}
          <div className={styles.frameParent4}>
            <div className={styles.headphonesParent}>
              <img className={styles.headphonesIcon} alt="" src={HeadphoneImage} />
              <div className={styles.maSalonu}>MaÃ§ Salonu</div>
            </div>
            <div className={styles.frameChild} />
            <div className={styles.footerWrapper}>
              <div className={styles.footer}>
                <div className={styles.divider} />
                <div className={styles.content}>
                  <div className={styles.actions}>
                    <div className={styles.inputField}>  
                      <input
                        type="text"
                        value={message}
                        onChange={handleMessageChange}
                        className={styles.content1}
                        placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
                      />
                    </div>
                    <div className={styles.button} onClick={handleSendMessage}>
                      <div className={styles.buttonBase2}>
                        <img className={styles.sendIcon} alt="" src={SendImage} />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div className={styles.malarmSalonChild} />
    </div>);
};

export default MalarmSalon;
